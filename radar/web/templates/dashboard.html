{% extends "base.html" %}

{% block title %}Dashboard - Radar{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Heartbeat Status -->
    <div class="card">
        <div class="card__header">
            <span class="card__title">Heartbeat</span>
        </div>
        <div class="heartbeat">
            <div class="heartbeat__visual">
                <div class="heartbeat__ring"></div>
                <div class="heartbeat__ring heartbeat__ring--pulse"></div>
                <div class="heartbeat__center"></div>
            </div>
            <div class="heartbeat__info">
                <div class="heartbeat__time">{{ last_heartbeat | default('2 min ago') }}</div>
                <div class="heartbeat__label">Last check-in</div>
                <div class="heartbeat__label mt-sm text-muted">Next in {{ next_heartbeat | default('13 min') }}</div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="card">
        <div class="card__header">
            <span class="card__title">Today</span>
        </div>
        <div class="card__body flex gap-md">
            <div class="stat" style="flex: 1;">
                <div class="stat__value">{{ conversations_today | default('12') }}</div>
                <div class="stat__label">Conversations</div>
            </div>
            <div class="stat" style="flex: 1;">
                <div class="stat__value">{{ tool_calls_today | default('47') }}</div>
                <div class="stat__label">Tool Calls</div>
            </div>
        </div>
    </div>

    <!-- Model Status -->
    <div class="card">
        <div class="card__header">
            <span class="card__title">Model</span>
        </div>
        <div class="card__body">
            <div class="stat">
                <div class="stat__value" style="font-size: 1.2rem;">{{ model | default('llama3.2') }}</div>
                <div class="stat__label">Active Model</div>
            </div>
            <div class="mt-md text-muted" style="font-size: 0.8rem; text-align: center;">
                {{ llm_provider | default('ollama') }} @ {{ llm_url | default('localhost:11434') }}
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card dashboard-grid__wide">
        <div class="card__header">
            <span class="card__title">Recent Activity</span>
            <button class="btn btn--ghost" style="padding: 4px 8px; font-size: 0.7rem;"
                    hx-get="/api/activity"
                    hx-target="#activity-log"
                    hx-swap="innerHTML">
                Refresh
            </button>
        </div>
        <div class="activity-log" id="activity-log">
            {% for item in activity | default([]) %}
            <div class="activity-log__item">
                <span class="activity-log__time">{{ item.time }}</span>
                <span class="activity-log__message">{{ item.message }}</span>
                <span class="activity-log__type activity-log__type--{{ item.type }}">{{ item.type }}</span>
            </div>
            {% else %}
            <div class="activity-log__item">
                <span class="activity-log__time">--:--</span>
                <span class="activity-log__message text-muted">No recent activity</span>
                <span class="activity-log__type">idle</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Notifications -->
    <div class="card">
        <div class="card__header">
            <span class="card__title">Notifications</span>
        </div>
        <div class="card__body">
            {% if ntfy_configured %}
            <div class="stat">
                <div class="stat__value">{{ notifications_sent | default('3') }}</div>
                <div class="stat__label">Sent Today</div>
            </div>
            {% else %}
            <div class="text-muted" style="font-size: 0.85rem; text-align: center; padding: var(--space-md);">
                <p>ntfy topic not configured</p>
                <a href="/config" class="text-phosphor">Configure â†’</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Plugin Widgets -->
    {% for widget in widgets | default([]) %}
    <div class="card" id="plugin-widget-{{ widget.name }}">
        <div class="card__header" style="display: flex; justify-content: space-between; align-items: center;">
            <span class="card__title">{{ widget.title }}</span>
            {% if widget.refresh_interval %}
            <button class="btn btn--ghost" style="padding: 4px 8px; font-size: 0.7rem;"
                    hx-get="/api/plugins/{{ widget.name }}/widget"
                    hx-target="#plugin-widget-content-{{ widget.name }}"
                    hx-swap="innerHTML"
                    hx-trigger="every {{ widget.refresh_interval }}s, click">
                Refresh
            </button>
            {% endif %}
        </div>
        <div class="card__body" id="plugin-widget-content-{{ widget.name }}">
            {{ widget.rendered }}
        </div>
    </div>
    {% endfor %}

    <!-- Quick Chat -->
    <div class="card dashboard-grid__full">
        <div class="card__header">
            <span class="card__title">Quick Ask</span>
        </div>
        <div class="card__body">
            <form hx-post="/api/ask"
                  hx-target="#quick-response"
                  hx-swap="innerHTML"
                  hx-indicator="#ask-indicator">
                <div class="flex gap-md">
                    <input type="text"
                           name="message"
                           class="input"
                           placeholder="Ask Radar something..."
                           autocomplete="off">
                    <button type="submit" class="btn btn--primary">
                        <span class="htmx-indicator" id="ask-indicator">...</span>
                        <span>Ask</span>
                    </button>
                </div>
            </form>
            <div id="quick-response" class="mt-md"></div>
        </div>
    </div>
</div>
{% endblock %}
